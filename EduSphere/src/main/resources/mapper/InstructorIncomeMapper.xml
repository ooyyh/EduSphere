<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.ooyyh.edusphere.mapper.InstructorIncomeMapper">

    <resultMap id="InstructorIncomeResultMap" type="top.ooyyh.edusphere.entity.InstructorIncome">
        <id column="id" property="id"/>
        <result column="instructor_id" property="instructorId"/>
        <result column="course_id" property="courseId"/>
        <result column="purchase_record_id" property="purchaseRecordId"/>
        <result column="income_amount" property="incomeAmount"/>
        <result column="total_income" property="totalIncome"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <select id="getByInstructorId" resultMap="InstructorIncomeResultMap">
        SELECT ii.*, c.title as course_title
        FROM instructor_income ii
        LEFT JOIN course c ON ii.course_id = c.id
        WHERE ii.instructor_id = #{instructorId}
        ORDER BY ii.created_at DESC
    </select>

    <select id="getTotalIncomeByInstructorId" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(income_amount), 0) 
        FROM instructor_income 
        WHERE instructor_id = #{instructorId}
    </select>

    <select id="getByInstructorIdWithPage" resultMap="InstructorIncomeResultMap">
        SELECT ii.*, c.title as course_title
        FROM instructor_income ii
        LEFT JOIN course c ON ii.course_id = c.id
        WHERE ii.instructor_id = #{instructorId}
        ORDER BY ii.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countByInstructorId" resultType="int">
        SELECT COUNT(*) FROM instructor_income WHERE instructor_id = #{instructorId}
    </select>

</mapper>
