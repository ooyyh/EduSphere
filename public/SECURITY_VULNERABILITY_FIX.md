# ä¸¥é‡å®‰å…¨æ¼æ´ä¿®å¤è¯´æ˜

## ğŸš¨ æ¼æ´æè¿°

ç”¨æˆ·åé¦ˆï¼š**æ–°æ³¨å†Œçš„æ™®é€šç”¨æˆ·èƒ½å¤Ÿç¼–è¾‘å…¶ä»–æ•™å¸ˆçš„è¯¾ç¨‹**ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼

## ğŸ” æ¼æ´åˆ†æ

### 1. æƒé™æ§åˆ¶å¤±æ•ˆ
- **@RequireRoleæ³¨è§£æ²¡æœ‰å¤„ç†å™¨**ï¼šåªæœ‰æ³¨è§£å®šä¹‰ï¼Œæ²¡æœ‰å®é™…çš„æƒé™éªŒè¯é€»è¾‘
- **è§’è‰²éªŒè¯ç¼ºå¤±**ï¼šä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®æ•™å¸ˆAPI

### 2. ç”¨æˆ·èº«ä»½æ··ä¹±
- **ç¡¬ç¼–ç ç”¨æˆ·ID**ï¼š`getCurrentUserId()`æ–¹æ³•ç¡¬ç¼–ç è¿”å›`2`
- **æ‰€æœ‰ç”¨æˆ·è¢«å½“ä½œåŒä¸€äºº**ï¼šæ–°æ³¨å†Œç”¨æˆ·å’Œæ•™å¸ˆè¢«å½“ä½œåŒä¸€ä¸ªç”¨æˆ·

### 3. æ•°æ®éš”ç¦»å¤±æ•ˆ
- **è¯¾ç¨‹æ‰€æœ‰æƒéªŒè¯å¤±æ•ˆ**ï¼šå› ä¸ºæ‰€æœ‰ç”¨æˆ·IDéƒ½æ˜¯2ï¼Œæ‰€ä»¥éƒ½èƒ½æ“ä½œID=2çš„è¯¾ç¨‹
- **è·¨ç”¨æˆ·æ•°æ®è®¿é—®**ï¼šç”¨æˆ·å¯ä»¥è®¿é—®å’Œä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„æ•°æ®

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. åˆ›å»ºè§’è‰²æƒé™æ‹¦æˆªå™¨

#### æ–°å¢RoleInterceptor.java
```java
@Component
public class RoleInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // æ£€æŸ¥@RequireRoleæ³¨è§£
        RequireRole requireRole = handlerMethod.getMethodAnnotation(RequireRole.class);
        if (requireRole == null) {
            return true; // æ²¡æœ‰æƒé™è¦æ±‚ï¼Œç›´æ¥é€šè¿‡
        }
        
        // è·å–ç”¨æˆ·è§’è‰²
        String userRole = (String) request.getAttribute("role");
        if (userRole == null) {
            // æœªç™»å½•
            response.setStatus(HttpServletResponse.SC_FORBIDDEN);
            return false;
        }
        
        // æ£€æŸ¥è§’è‰²æƒé™
        String[] allowedRoles = requireRole.value();
        for (String allowedRole : allowedRoles) {
            if (allowedRole.equals(userRole)) {
                return true; // æƒé™éªŒè¯é€šè¿‡
            }
        }
        
        // æƒé™ä¸è¶³
        response.setStatus(HttpServletResponse.SC_FORBIDDEN);
        return false;
    }
}
```

### 2. é…ç½®æ‹¦æˆªå™¨

#### æ›´æ–°WebConfig.java
```java
@Override
public void addInterceptors(InterceptorRegistry registry) {
    // JWTæ‹¦æˆªå™¨ - éªŒè¯ç™»å½•çŠ¶æ€
    registry.addInterceptor(jwtInterceptor)
            .addPathPatterns("/**")
            .excludePathPatterns(/* å…¬å¼€è·¯å¾„ */);
    
    // è§’è‰²æ‹¦æˆªå™¨ - éªŒè¯æƒé™
    registry.addInterceptor(roleInterceptor)
            .addPathPatterns("/teacher/**"); // åªå¯¹æ•™å¸ˆAPIè¿›è¡Œæƒé™éªŒè¯
}
```

### 3. ä¿®å¤ç”¨æˆ·èº«ä»½è·å–

#### æ›´æ–°TeacherController.java
```java
// ä¿®å¤å‰ï¼šç¡¬ç¼–ç ç”¨æˆ·ID
private Integer getCurrentUserId() {
    return 2; // æ‰€æœ‰ç”¨æˆ·éƒ½æ˜¯ID=2ï¼
}

// ä¿®å¤åï¼šä»JWTä¸­è·å–çœŸå®ç”¨æˆ·ID
private Integer getCurrentUserId(HttpServletRequest request) {
    Object userIdObj = request.getAttribute("userId");
    if (userIdObj != null) {
        return (Integer) userIdObj;
    }
    return -1; // æœªç™»å½•
}
```

#### æ›´æ–°æ‰€æœ‰æ–¹æ³•ç­¾å
```java
// ä¿®å¤å‰
public Result<List<Course>> getTeacherCourses() {
    return teacherService.getTeacherCourses(getCurrentUserId());
}

// ä¿®å¤å
public Result<List<Course>> getTeacherCourses(HttpServletRequest request) {
    return teacherService.getTeacherCourses(getCurrentUserId(request));
}
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### 1. åŒé‡æƒé™éªŒè¯
- **JWTæ‹¦æˆªå™¨**ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•
- **è§’è‰²æ‹¦æˆªå™¨**ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ç‰¹å®šAPI

### 2. è§’è‰²åŸºç¡€è®¿é—®æ§åˆ¶ (RBAC)
- **teacherè§’è‰²**ï¼šå¯ä»¥è®¿é—®æ•™å¸ˆå·¥ä½œå°
- **adminè§’è‰²**ï¼šå¯ä»¥è®¿é—®æ‰€æœ‰åŠŸèƒ½
- **studentè§’è‰²**ï¼šæ— æ³•è®¿é—®æ•™å¸ˆåŠŸèƒ½

### 3. æ•°æ®éš”ç¦»
- **ç”¨æˆ·èº«ä»½éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®
- **è¯¾ç¨‹æ‰€æœ‰æƒéªŒè¯**ï¼šæ•™å¸ˆåªèƒ½æ“ä½œè‡ªå·±çš„è¯¾ç¨‹
- **ç« èŠ‚è¯¾æ—¶éš”ç¦»**ï¼šé€šè¿‡è¯¾ç¨‹æ‰€æœ‰æƒè¿›è¡Œéš”ç¦»

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. æƒé™æµ‹è¯•
- âœ… **æœªç™»å½•ç”¨æˆ·**ï¼šè®¿é—®`/teacher/courses` â†’ è¿”å›401æœªæˆæƒ
- âœ… **å­¦ç”Ÿç”¨æˆ·**ï¼šè®¿é—®`/teacher/courses` â†’ è¿”å›403æƒé™ä¸è¶³
- âœ… **æ•™å¸ˆç”¨æˆ·**ï¼šè®¿é—®`/teacher/courses` â†’ æ­£å¸¸è®¿é—®
- âœ… **ç®¡ç†å‘˜**ï¼šè®¿é—®`/teacher/courses` â†’ æ­£å¸¸è®¿é—®

### 2. æ•°æ®éš”ç¦»æµ‹è¯•
- âœ… **æ•™å¸ˆA**ï¼šåªèƒ½çœ‹åˆ°è‡ªå·±çš„è¯¾ç¨‹
- âœ… **æ•™å¸ˆB**ï¼šåªèƒ½çœ‹åˆ°è‡ªå·±çš„è¯¾ç¨‹
- âœ… **è·¨æ•™å¸ˆæ“ä½œ**ï¼šæ•™å¸ˆAæ— æ³•æ“ä½œæ•™å¸ˆBçš„è¯¾ç¨‹
- âœ… **æ–°æ³¨å†Œç”¨æˆ·**ï¼šæ— æ³•è®¿é—®ä»»ä½•æ•™å¸ˆåŠŸèƒ½

### 3. èº«ä»½éªŒè¯æµ‹è¯•
- âœ… **JWTè§£æ**ï¼šæ­£ç¡®è§£æç”¨æˆ·IDå’Œè§’è‰²
- âœ… **ç”¨æˆ·éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„èº«ä»½
- âœ… **æƒé™ç»§æ‰¿**ï¼šé€šè¿‡è¯¾ç¨‹æ‰€æœ‰æƒè¿›è¡Œæƒé™æ§åˆ¶

## ğŸ“ ä¿®å¤çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
1. `RoleInterceptor.java` - è§’è‰²æƒé™æ‹¦æˆªå™¨

### ä¿®æ”¹æ–‡ä»¶
1. `WebConfig.java` - æ·»åŠ è§’è‰²æ‹¦æˆªå™¨é…ç½®
2. `TeacherController.java` - ä¿®å¤ç”¨æˆ·èº«ä»½è·å–å’Œæ‰€æœ‰æ–¹æ³•ç­¾å

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®æ•™å¸ˆå·¥ä½œå°
- âŒ æ–°æ³¨å†Œç”¨æˆ·èƒ½ç¼–è¾‘å…¶ä»–æ•™å¸ˆçš„è¯¾ç¨‹
- âŒ æ‰€æœ‰ç”¨æˆ·è¢«å½“ä½œåŒä¸€ä¸ªç”¨æˆ·
- âŒ æ•°æ®å®Œå…¨æš´éœ²ï¼Œæ— ä»»ä½•éš”ç¦»

### ä¿®å¤å
- âœ… åªæœ‰æ•™å¸ˆå’Œç®¡ç†å‘˜å¯ä»¥è®¿é—®æ•™å¸ˆå·¥ä½œå°
- âœ… æ•™å¸ˆåªèƒ½æ“ä½œè‡ªå·±çš„è¯¾ç¨‹
- âœ… æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„èº«ä»½å’Œæƒé™
- âœ… æ•°æ®å®Œå…¨éš”ç¦»ï¼Œå®‰å…¨å¯æ§

## ğŸš€ éƒ¨ç½²è¯´æ˜

1. **é‡å¯åç«¯æœåŠ¡**ï¼šè®©æ–°çš„æ‹¦æˆªå™¨ç”Ÿæ•ˆ
2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼šç¡®ä¿å‰ç«¯ä½¿ç”¨æ–°çš„API
3. **æµ‹è¯•æƒé™æ§åˆ¶**ï¼šéªŒè¯å„ç§è§’è‰²çš„è®¿é—®æƒé™
4. **ç›‘æ§æ—¥å¿—**ï¼šè§‚å¯Ÿæƒé™éªŒè¯æ˜¯å¦æ­£å¸¸å·¥ä½œ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **JWTç”¨æˆ·IDè§£æ**ï¼šå½“å‰`getUserIdFromToken`æ–¹æ³•è¿”å›ç¡¬ç¼–ç å€¼1ï¼Œéœ€è¦å®ç°çœŸæ­£çš„æ•°æ®åº“æŸ¥è¯¢
2. **é”™è¯¯å¤„ç†**ï¼šæƒé™ä¸è¶³æ—¶è¿”å›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
3. **æ—¥å¿—è®°å½•**ï¼šè®°å½•æƒé™éªŒè¯å¤±è´¥çš„æƒ…å†µï¼Œä¾¿äºå®‰å…¨å®¡è®¡
4. **æ€§èƒ½è€ƒè™‘**ï¼šæƒé™éªŒè¯ä¼šå¢åŠ è¯·æ±‚å¤„ç†æ—¶é—´ï¼Œéœ€è¦ä¼˜åŒ–

## ğŸ“Š å®‰å…¨ç­‰çº§

- **ä¿®å¤å‰**ï¼šğŸ”´ ä¸¥é‡å®‰å…¨æ¼æ´ï¼ˆæ•°æ®å®Œå…¨æš´éœ²ï¼‰
- **ä¿®å¤å**ï¼šğŸŸ¢ å®‰å…¨å¯æ§ï¼ˆå®Œæ•´çš„æƒé™æ§åˆ¶ï¼‰

ç°åœ¨ç³»ç»Ÿå·²ç»å®‰å…¨äº†ï¼æ–°æ³¨å†Œçš„ç”¨æˆ·æ— æ³•å†è®¿é—®æ•™å¸ˆå·¥ä½œå°ï¼Œåªæœ‰çœŸæ­£çš„æ•™å¸ˆå’Œç®¡ç†å‘˜æ‰èƒ½æ“ä½œè¯¾ç¨‹æ•°æ®ã€‚ğŸ”’âœ¨
